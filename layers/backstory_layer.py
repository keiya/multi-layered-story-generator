from typing import Optional
from utils import call_llm

def backstory_layer(master_plot: str) -> str:
    """
    Backstory Layer:
    Plot Layer で生成したプロットをベースに世界観の設定を出力するレイヤー。
    マスタープロットを受け取り、物語の世界の歴史、文化、地理、魔法システムなど
    の詳細な背景設定を生成します。

    Args:
        master_plot (str): Plot Layer で生成されたマスタープロット

    Returns:
        str: backstories (物語世界の背景設定)
    """
    prompt = f"""
    あなたは多層的物語生成システムの一部として、物語の背景設定（バックストーリー）を生成する専門家です。
    以下のマスタープロットに基づいて、物語の世界観を詳細に描写してください。

    # マスタープロット
    {master_plot}

    # 指示
    以下の要素を含む、マスタープロットと一貫性のある背景設定を生成してください：
    1. 世界の歴史 - 重要な出来事、時代、転換点
    2. 地理 - 主要な場所、国、地域とその特徴
    3. 文化と社会 - 習慣、伝統、社会構造、信仰体系
    4. 魔法/テクノロジーシステム - 仕組み、制限、社会における役割
    5. 種族/集団 - 存在する場合、その特徴や関係性

    背景設定は、物語に深みと信頼性を与え、登場人物や出来事に文脈を提供します。
    マスタープロットで既に述べられている情報と矛盾しないように注意してください。
    適度な長さ（約3000文字）で、物語世界を理解するのに十分な詳細を含めてください。
    特に、現実世界で一般的でない用語や背景設定については詳細に掘り下げてください。
    """
    
    backstories = call_llm(prompt)
    return backstories 
